<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- 務必使用 UTF-8 編碼，否則中文會變亂碼 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Expedition Compass - 極簡版</title>
    <!-- 載入 Tailwind CSS (負責樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 Lucide Icons (負責圖示) - 使用 UMD 版本確保穩定 -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* 字體設定 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* 羅盤轉動動畫 */
        #compass-dial {
            transition: transform 0.1s ease-out; /* 反應速度 */
            will-change: transform;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-white flex items-center justify-center p-4">

    <!-- 背景特效 -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/10 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-orange-600/10 rounded-full blur-[100px]"></div>
    </div>

    <!-- iPad 外框容器 -->
    <div id="app-container" class="relative w-full max-w-3xl aspect-[3/4] md:aspect-[4/3] bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 rounded-[3rem] shadow-2xl flex flex-col overflow-hidden ring-1 ring-white/10">
        
        <!-- 頂部狀態列 -->
        <div class="h-8 w-full flex justify-between items-center px-8 mt-5 opacity-60">
            <span class="text-xs font-medium tracking-wide">COMPASS MODE</span>
            <div class="flex gap-2">
                <div id="permission-dot" class="w-4 h-4 rounded-full border border-current opacity-50 transition-colors"></div>
                <div class="w-4 h-4 rounded-full border border-current opacity-50"></div>
                <div class="w-6 h-3 rounded-sm border border-current relative">
                    <div class="absolute inset-[2px] bg-white rounded-[1px]"></div>
                </div>
            </div>
        </div>

        <!-- 主要內容區 (使用 justify-center 讓羅盤垂直置中) -->
        <div class="flex-1 flex flex-col items-center justify-center py-6 px-6 relative z-10 gap-8">
            
            <!-- 標題 -->
            <div class="text-center">
                <div class="flex items-center justify-center gap-2 text-orange-500 tracking-[0.3em] text-[10px] md:text-xs font-bold uppercase">
                    <i data-lucide="compass" class="w-4 h-4"></i>
                    <span>Pro Expedition Compass</span>
                </div>
            </div>

            <!-- 羅盤圓盤區域 -->
            <div class="relative w-72 h-72 md:w-[420px] md:h-[420px] flex items-center justify-center">
                
                <!-- 鎖定畫面 / 啟動按鈕 (未授權時顯示) -->
                <div id="lock-screen" class="absolute inset-0 z-50 flex items-center justify-center backdrop-blur-sm bg-slate-900/60 rounded-full">
                    <button 
                        id="start-btn"
                        class="flex flex-col items-center gap-3 bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded-2xl shadow-lg transition-all active:scale-95 animate-pulse"
                    >
                        <i data-lucide="lock" class="w-6 h-6"></i>
                        <span class="font-bold tracking-widest">點擊啟動羅盤</span>
                        <span class="text-[10px] opacity-80">授權 iPad 感測器權限</span>
                    </button>
                </div>

                <!-- 羅盤外圈 -->
                <div class="absolute inset-0 rounded-full border-2 border-slate-700/50"></div>
                <div class="absolute inset-2 rounded-full border border-slate-700/30"></div>

                <!-- 可旋轉的盤面 -->
                <div id="compass-dial" class="w-full h-full relative">
                    <!-- 刻度線將由 JavaScript 自動生成 -->
                    
                    <!-- 方位文字 -->
                    <div id="dial-n" class="absolute font-bold text-3xl md:text-4xl text-red-500 flex items-center justify-center" style="width: 40px; height: 40px;">北</div>
                    <div id="dial-e" class="absolute font-bold text-3xl md:text-4xl text-slate-200 flex items-center justify-center" style="width: 40px; height: 40px;">東</div>
                    <div id="dial-s" class="absolute font-bold text-3xl md:text-4xl text-slate-200 flex items-center justify-center" style="width: 40px; height: 40px;">南</div>
                    <div id="dial-w" class="absolute font-bold text-3xl md:text-4xl text-slate-200 flex items-center justify-center" style="width: 40px; height: 40px;">西</div>

                    <!-- 紅色北方指針 -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-slate-900 rounded-full border-2 border-red-500 z-20"></div>
                </div>

                <!-- 固定指針 (橘色箭頭) -->
                <div class="absolute top-[-10px] left-1/2 -translate-x-1/2 drop-shadow-[0_0_10px_rgba(249,115,22,0.5)]">
                    <div class="w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[20px] border-t-orange-500"></div>
                </div>

                <!-- 中央數字顯示 -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center z-30 flex flex-col items-center justify-center w-full pointer-events-none">
                    <div id="display-zh" class="text-6xl md:text-8xl font-bold text-white drop-shadow-xl tracking-wider leading-none">--</div>
                    <div class="flex items-center gap-2 mt-3 bg-slate-900/40 backdrop-blur-sm px-3 py-1 rounded-full border border-white/10">
                        <span id="display-en" class="text-xl md:text-2xl font-bold text-orange-400">--</span>
                        <div class="w-[1px] h-4 bg-white/20 mx-1"></div>
                        <span id="display-deg" class="text-sm md:text-base text-slate-300 font-mono">0°</span>
                    </div>
                </div>
            </div>
            
            <!-- 底部空白填充，確保視覺平衡 -->
            <div class="h-8"></div>
        </div>
    </div>

    <!-- 錯誤訊息 Modal (僅用於權限錯誤) -->
    <div id="error-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 backdrop-blur-sm p-4">
        <div class="bg-slate-800 p-6 rounded-3xl w-full max-w-md mx-4 border border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-red-400 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    <span>權限錯誤</span>
                </h2>
                <button id="modal-close" class="text-slate-400 hover:text-white p-1 rounded-full bg-slate-700/50">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modal-content" class="text-slate-300 text-sm leading-relaxed mb-4"></div>
        </div>
    </div>

    <script>
        // ================= 設定與狀態 =================
        const state = {
            heading: 0,
            permissionGranted: false
        };

        // ================= 初始化 DOM =================
        const els = {
            dial: document.getElementById('compass-dial'),
            lockScreen: document.getElementById('lock-screen'),
            permissionDot: document.getElementById('permission-dot'),
            startBtn: document.getElementById('start-btn'),
            displayZh: document.getElementById('display-zh'),
            displayEn: document.getElementById('display-en'),
            displayDeg: document.getElementById('display-deg'),
            // Modal DOMs
            modal: document.getElementById('error-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            modalClose: document.getElementById('modal-close')
        };

        // ================= 輔助函數 =================
        function getCardinalDirection(deg) {
            const directions = ["北 N", "東北 NE", "東 E", "東南 SE", "南 S", "西南 SW", "西 W", "西北 NW"];
            const index = Math.round(((deg %= 360) < 0 ? deg + 360 : deg) / 45) % 8;
            return directions[index];
        }

        function createIcons() {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }

        // ================= 羅盤繪製 =================
        function initCompassMarks() {
            const dial = els.dial;
            // 繪製 72 個刻度
            for (let i = 0; i < 72; i++) {
                const deg = i * 5;
                const isMajor = i % 9 === 0; 
                const isSemi = i % 3 === 0;
                
                // 創建一個旋轉的容器，將刻度放在容器的頂部
                const wrapper = document.createElement('div');
                wrapper.className = 'absolute inset-0';
                wrapper.style.transform = `rotate(${deg}deg)`;
                
                const tick = document.createElement('div');
                tick.className = 'mx-auto';
                tick.style.height = isMajor ? '24px' : (isSemi ? '14px' : '8px');
                tick.style.width = isMajor ? '3px' : '1px';
                tick.style.backgroundColor = isMajor ? (i === 0 ? '#ef4444' : 'white') : 'rgba(255,255,255,0.3)';
                
                wrapper.appendChild(tick);
                dial.appendChild(wrapper);
            }
            
            // 定位方位文字 (北東西南)
            const setPos = (id, deg) => {
                const el = document.getElementById(id);
                // 使用 CSS 放置在圓周上 (半徑約 45% 以避開邊緣)
                const rad = (deg - 90) * (Math.PI / 180);
                const r = 35; // % (距離中心的百分比)
                const x = 50 + r * Math.cos(rad);
                const y = 50 + r * Math.sin(rad);
                el.style.left = x + '%';
                el.style.top = y + '%';
                el.style.transform = `translate(-50%, -50%) rotate(${deg}deg)`;
            };
            setPos('dial-n', 0);
            setPos('dial-e', 90);
            setPos('dial-s', 180);
            setPos('dial-w', 270);
        }

        // ================= 更新 UI =================
        function updateUI() {
            // 旋轉盤面
            els.dial.style.transform = `rotate(${-state.heading}deg)`;
            
            // 數值顯示
            const [zh, en] = getCardinalDirection(state.heading).split(" ");
            els.displayZh.textContent = zh;
            els.displayEn.textContent = en;
            els.displayDeg.textContent = Math.round(state.heading) + "°";
            
            createIcons();
        }

        // ================= 權限與感測器 =================
        function handleOrientation(e) {
            let heading = 0;
            if (e.webkitCompassHeading) {
                heading = e.webkitCompassHeading;
            } else if (e.alpha !== null) {
                heading = 360 - e.alpha;
            }
            state.heading = heading;
            updateUI();
        }

        function showError(content) {
            els.modalContent.innerHTML = `<p>${content}</p>`;
            els.modal.classList.remove('hidden');
            createIcons();
        }

        els.startBtn.addEventListener('click', async () => {
            // iOS 權限請求
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') {
                        state.permissionGranted = true;
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    } else {
                        showError("羅盤權限被拒絕。請至 iPad 設定 > Safari > 網站設定中開啟「動作與方向取用權限」。");
                        return;
                    }
                } catch (e) {
                    showError("無法請求權限。請確認此網頁是否透過 HTTPS 連線開啟。");
                    console.error(e);
                    return;
                }
            } else {
                // 非 iOS 13+ 或 Android
                state.permissionGranted = true;
                window.addEventListener('deviceorientation', handleOrientation, true);
            }

            // 更新 UI 狀態
            els.lockScreen.classList.add('hidden');
            els.permissionDot.classList.remove('opacity-50');
            els.permissionDot.classList.add('bg-green-500', 'border-green-500');
            updateUI();
        });

        els.modalClose.addEventListener('click', () => {
            els.modal.classList.add('hidden');
        });

        // 啟動
        initCompassMarks();
        createIcons();
    </script>
</body>
</html>
